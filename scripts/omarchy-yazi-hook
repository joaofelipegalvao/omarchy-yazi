#!/bin/bash
# Omarchy Yazi Theme Hook
# Automatically syncs Yazi theme when Omarchy theme changes

set -euo pipefail

readonly THEME="${1:-}"
readonly THEME_DIR="$HOME/.config/omarchy/themes/$THEME"
readonly THEME_YAZI="$THEME_DIR/theme-yazi.toml"
readonly YAZI_CONF="$HOME/.config/yazi/theme.toml"
readonly YAZI_STATE="$HOME/.local/state/yazi"

log() { echo "[omarchy-yazi] $*" >&2; }
error() {
  echo "[omarchy-yazi] ERROR: $*" >&2
  exit 1
}

[[ -z "$THEME" ]] && error "No theme specified"

[[ ! -f "$THEME_YAZI" ]] && error "Theme file not found: $THEME_YAZI"

if [[ -f "$YAZI_CONF" ]] && [[ ! -L "$YAZI_CONF" ]]; then
  cp "$YAZI_CONF" "$YAZI_CONF.backup.$(date +%Y%m%d_%H%M%S)"
  log "Backed up existing theme configuration"
fi

ln -sf "$THEME_YAZI" "$YAZI_CONF" || error "Failed to create symlink"
log "Linked theme: $THEME"

if [[ -d "$YAZI_STATE" ]]; then
  rm -rf "$YAZI_STATE"
  log "Cleared Yazi state cache"
fi

find "$HOME/.config/yazi" -maxdepth 1 -name "theme.toml-*" -type f -delete 2>/dev/null || true

log "Theme switch complete: $THEME"
